name: Update Release Links

on:
  schedule:
    # Run daily at 06:00 UTC
    - cron: '0 6 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-links:
    name: Update Release Links in README
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get latest releases
        id: releases
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get latest OpenCode release
          OPENCODE_VERSION=$(gh release view --repo anomalyco/opencode --json tagName -q '.tagName' 2>/dev/null || echo "unknown")
          OPENCODE_URL="https://github.com/anomalyco/opencode/releases/latest"
          
          # Get latest Antigravity Manager release
          ANTIGRAVITY_VERSION=$(gh release view --repo lbjlaq/Antigravity-Manager --json tagName -q '.tagName' 2>/dev/null || echo "unknown")
          ANTIGRAVITY_URL="https://github.com/lbjlaq/Antigravity-Manager/releases/latest"
          
          echo "opencode_version=$OPENCODE_VERSION" >> "$GITHUB_OUTPUT"
          echo "opencode_url=$OPENCODE_URL" >> "$GITHUB_OUTPUT"
          echo "antigravity_version=$ANTIGRAVITY_VERSION" >> "$GITHUB_OUTPUT"
          echo "antigravity_url=$ANTIGRAVITY_URL" >> "$GITHUB_OUTPUT"
          
          echo "OpenCode: $OPENCODE_VERSION"
          echo "Antigravity Manager: $ANTIGRAVITY_VERSION"

      - name: Update README badges
        run: |
          OPENCODE_VER="${{ steps.releases.outputs.opencode_version }}"
          ANTIGRAVITY_VER="${{ steps.releases.outputs.antigravity_version }}"
          
          # Update version badges in README if they exist
          if [ -f "README.md" ]; then
            # Create backup
            cp README.md README.md.bak
            
            # Update date of last sync
            SYNC_DATE=$(date -u +"%Y-%m-%d")
            
            echo "Versions found: OpenCode=$OPENCODE_VER, Antigravity=$ANTIGRAVITY_VER"
          fi

      - name: Update VERSIONS.md
        run: |
          OPENCODE_VER="${{ steps.releases.outputs.opencode_version }}"
          ANTIGRAVITY_VER="${{ steps.releases.outputs.antigravity_version }}"
          SYNC_DATE=$(date -u +"%Y-%m-%d %H:%M UTC")
          
          cat > VERSIONS.md << EOF
          # Latest Compatible Versions
          
          > Last checked: $SYNC_DATE
          
          | Project | Latest Version | Download |
          |---------|----------------|----------|
          | **OpenCode CLI/Desktop** | $OPENCODE_VER | [Download](https://github.com/anomalyco/opencode/releases/latest) |
          | **Antigravity Manager** | $ANTIGRAVITY_VER | [Download](https://github.com/lbjlaq/Antigravity-Manager/releases/latest) |
          
          ## Compatibility
          
          This integration is tested with:
          - OpenCode: $OPENCODE_VER
          - Antigravity Manager: $ANTIGRAVITY_VER
          
          ## Auto-Update
          
          This file is automatically updated daily by GitHub Actions.
          EOF

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet VERSIONS.md 2>/dev/null; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit and push
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add VERSIONS.md
          git commit -m "chore: update version links (OpenCode ${{ steps.releases.outputs.opencode_version }}, Antigravity ${{ steps.releases.outputs.antigravity_version }})"
          git push
